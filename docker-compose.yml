services:
  database:
    image: postgres:15
    container_name: postgres
    restart: unless-stopped
    env_file: &env-file
      - path: ./.env
        required: true
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  adminer:
    image: adminer
    container_name: adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    networks:
      - app-network
    depends_on:
      - database

  migrate:
    image: node:22-alpine
    container_name: migrate
    working_dir: /app
    env_file: *env-file
    volumes:
      - ./database:/app
    networks:
      - app-network
    command: >
      sh -c "apk add --no-cache postgresql-client &&
             yarn install --frozen-lockfile &&
             DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database:5432/${POSTGRES_DB} yarn prisma migrate deploy &&
             PGPASSWORD=${POSTGRES_PASSWORD} psql -h database -U ${POSTGRES_USER} -d ${POSTGRES_DB} -v data_writer_pass=${DATA_WRITER_PASS} -v data_reader_pass=${DATA_READER_PASS} -f /app/init/001_users.sql"
    restart: "no"
    depends_on:
      database:
        condition: service_healthy

  metrics-migrate:
    image: postgres:15
    container_name: metrics-migrate
    env_file: *env-file
    volumes:
      - ./metrics/schema:/scripts:ro
    networks:
      - app-network
    environment:
      - PGPASSWORD=${METRICS_PASSWORD}

    command: >
      sh -c "for f in /scripts/*.sql; do
               echo \"Running $$f...\";
               psql -h timescaledb -U ${METRICS_USER} -d ${METRICS_DB} -v metrics_writer_pass=${METRICS_WRITER_PASS} -v metrics_reader_pass=${METRICS_READER_PASS} -f $$f;
             done"
    restart: "no"
    depends_on:
      timescaledb:
        condition: service_healthy

  api:
    build:
      context: .
      dockerfile: api/Dockerfile.dev
    container_name: api
    restart: unless-stopped
    env_file: *env-file
    environment:
      - DATABASE_URL=postgresql://data_reader:${DATA_READER_PASS}@database:5432/${POSTGRES_DB}
      - NODE_ENV=development
    ports:
      - "3000:3000"
    networks:
      - app-network
    volumes:
      - ./api/src:/app/src
      - ./api/public:/app/public
      - ./api/next.config.js:/app/next.config.js
      - ./api/tsconfig.json:/app/tsconfig.json
      - ./database/prisma:/app/prisma:ro
    depends_on:
      migrate:
        condition: service_completed_successfully
    develop:
      watch:
        - action: sync
          path: ./api/src
          target: /app/src
        - action: sync
          path: ./api/public
          target: /app/public
        - action: rebuild
          path: ./api/package.json
        - action: sync+restart
          path: ./database/prisma/schema.prisma
          target: /app/prisma/schema.prisma

  scraper:
    build:
      context: ./scraper
      dockerfile: Dockerfile
    container_name: scraper
    restart: "no"
    env_file: *env-file
    environment:
      - TZ=Europe/Athens
      - DATABASE_URL=postgresql://data_writer:${DATA_WRITER_PASS}@database:5432/${POSTGRES_DB}
      - METRICS_URL=http://telegraf:8186/write
    networks:
      - app-network
    depends_on:
      migrate:
        condition: service_started
      telegraf:
        condition: service_started
    develop:
      watch:
        - action: rebuild
          path: ./scraper
          ignore:
            - scraper/dist/

  web:
    build:
      context: ./web
      dockerfile: Dockerfile.dev
    container_name: web
    restart: unless-stopped
    ports:
      - "8080:5173"
    networks:
      - app-network
    environment:
      - VITE_API_URL=http://api:3000
    volumes:
      - ./web/src:/app/src
      - ./web/public:/app/public
      - ./web/index.html:/app/index.html
      - ./web/vite.config.ts:/app/vite.config.ts
      - ./web/tsconfig.json:/app/tsconfig.json
    depends_on:
      - api
    develop:
      watch:
        - action: sync
          path: ./web/src
          target: /app/src
        - action: sync
          path: ./web/index.html
          target: /app/index.html
        - action: rebuild
          path: ./web/package.json

  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: timescaledb
    restart: unless-stopped
    env_file: *env-file
    environment:
      - POSTGRES_USER=${METRICS_USER}
      - POSTGRES_PASSWORD=${METRICS_PASSWORD}
      - POSTGRES_DB=${METRICS_DB}
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${METRICS_USER} -d ${METRICS_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      database:
        condition: service_healthy

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    env_file: *env-file
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./metrics/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./metrics/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3001:3000"
    networks:
      - app-network
    depends_on:
      migrate:
        condition: service_completed_successfully
      metrics-migrate:
        condition: service_completed_successfully

  telegraf:
    image: telegraf:latest
    container_name: telegraf
    restart: unless-stopped
    env_file: *env-file
    volumes:
      - ./metrics/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - telegraf_logs:/var/log/telegraf
    ports:
      - "8186:8186"
    networks:
      - app-network
    depends_on:
      metrics-migrate:
        condition: service_completed_successfully
      web:
        condition: service_started
      api:
        condition: service_started

networks:
  app-network:
    driver: bridge

volumes:
  pgdata:
  timescaledb_data:
  grafana_data:
  telegraf_logs:
