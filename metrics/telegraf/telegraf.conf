# Telegraf Configuration for Price Watchdog Metrics Collection

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = "price-watchdog"
  omit_hostname = false

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# Pull: nginx stub_status metrics (only works with production nginx, not dev Vite)
# Uncomment when using production web container
# [[inputs.nginx]]
#   urls = ["http://web:80/stub_status"]
#   response_timeout = "5s"
#   interval = "10s"
#   [inputs.nginx.tags]
#     service = "web"

# Pull: Server (Next.js) metrics endpoint
[[inputs.http]]
  urls = ["http://server:3000/api/metrics"]
  timeout = "5s"
  method = "GET"
  data_format = "json"
  name_override = "server_metrics"
  interval = "10s"
  [inputs.http.tags]
    service = "server"

# Push: HTTP listener for scraper and other batch jobs
# Scraper POSTs to http://telegraf:8186/write in InfluxDB line protocol
[[inputs.http_listener_v2]]
  service_address = ":8186"
  paths = ["/write"]
  methods = ["POST"]
  read_timeout = "10s"
  write_timeout = "10s"
  max_body_size = "1MB"
  data_format = "influx"
  [inputs.http_listener_v2.tags]
    source = "push"

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

# Output to TimescaleDB
[[outputs.postgresql]]
  connection = "host=timescaledb user=metrics_writer password=metrics_writer_pass dbname=metrics_db sslmode=disable"

  # Use TIMESTAMPTZ for time column (TimescaleDB best practice)
  timestamp_column_name = "time"
  timestamp_column_type = "timestamp with time zone"

  # Create hypertables for time-series optimization
  create_templates = [
    '''CREATE TABLE IF NOT EXISTS {{ .table }} ({{.columns}})''',
    '''SELECT create_hypertable({{ .table|quoteLiteral }}, 'time', chunk_time_interval => INTERVAL '1 day', if_not_exists => TRUE)''',
  ]

  add_column_templates = [
    '''ALTER TABLE {{ .table }} ADD COLUMN IF NOT EXISTS {{.columns|join ", ADD COLUMN IF NOT EXISTS "}}''',
  ]

  tags_as_foreign_keys = false

# Debug output (remove in production)
[[outputs.file]]
  files = ["stdout"]
  data_format = "influx"
