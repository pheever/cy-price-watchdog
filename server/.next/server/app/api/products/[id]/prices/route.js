"use strict";(()=>{var e={};e.id=100,e.ids=[100],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:e=>{e.exports=import("pg")},7617:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>l,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var o=r(9303),a=r(8716),i=r(670),s=r(7242),u=e([s]);s=(u.then?(await u)():u)[0];let d=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/products/[id]/prices/route",pathname:"/api/products/[id]/prices",filename:"route",bundlePath:"app/api/products/[id]/prices/route"},resolvedPagePath:"/home/phivos/source/github.com/pheever/cy-price-watchdog/server/src/app/api/products/[id]/prices/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:m}=d,f="/api/products/[id]/prices/route";function l(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}n()}catch(e){n(e)}})},7242:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{GET:()=>l});var o=r(3538),a=r(9406),i=r(6097),s=r(4235),u=e([o]);async function l(e,{params:t}){let{id:r}=await t,n=(0,i.i)(e);if(!(0,i.D)(`prices:${n}`).allowed)return a.R0.rateLimit();let{searchParams:u}=new URL(e.url),l=(0,s.Vj)(u,s.Gb);if(!l.success)return a.R0.validation((0,s.lf)(l.error));let{cursor:d,limit:c,storeId:p,from:m,to:f}=l.data;try{if(!await o._.product.findUnique({where:{id:r},select:{id:!0}}))return a.R0.notFound("Product");let e={productId:r};p&&(e.storeId=p),(m||f)&&(e.scrapedAt={},m&&(e.scrapedAt.gte=m),f&&(e.scrapedAt.lte=f));let t=await o._.price.findMany({where:e,take:c+1,cursor:d?{id:d}:void 0,skip:d?1:0,include:{store:!0},orderBy:{scrapedAt:"desc"}}),n=t.length>c,i=n?t.slice(0,-1):t,s=n&&i.length>0?i[i.length-1]?.id:void 0;return(0,a.e9)(i,{cursor:s,hasNext:n})}catch(e){return console.error("Failed to fetch price history:",e),a.R0.internal()}}o=(u.then?(await u)():u)[0],n()}catch(e){n(e)}})},3538:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{_:()=>u});var o=r(3524),a=r(9683),i=r(8678),s=e([i,a]);[i,a]=s.then?(await s)():s;let u=globalThis.prisma??function(){let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL environment variable is required");let t=new i.Pool({connectionString:e}),r=new a.g(t);return new o.PrismaClient({adapter:r,log:["error"]})}();n()}catch(e){n(e)}})},6097:(e,t,r)=>{r.d(t,{D:()=>o,i:()=>a});let n=new Map;function o(e,t={windowMs:6e4,maxRequests:100}){let r=Date.now(),o=n.get(e);return!o||o.resetAt<r?(n.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetAt:r+t.windowMs}):o.count>=t.maxRequests?{allowed:!1,remaining:0,resetAt:o.resetAt}:(o.count++,{allowed:!0,remaining:t.maxRequests-o.count,resetAt:o.resetAt})}function a(e){let t=e.headers.get("x-forwarded-for");return t?t.split(",")[0]?.trim()??"unknown":e.headers.get("x-real-ip")??"unknown"}setInterval(()=>{let e=Date.now();for(let[t,r]of n.entries())r.resetAt<e&&n.delete(t)},6e4)},9406:(e,t,r)=>{r.d(t,{R0:()=>s,Vp:()=>o,e9:()=>a});var n=r(7070);function o(e,t){return n.NextResponse.json({data:e,error:null,meta:t??null})}function a(e,t){return n.NextResponse.json({data:e,error:null,meta:{cursor:t.cursor,hasNext:t.hasNext,total:t.total}})}function i(e,t,r,o){return n.NextResponse.json({data:null,error:{code:e,message:t,fields:o},meta:null},{status:r})}let s={notFound:e=>i("NOT_FOUND",`${e} not found`,404),badRequest:(e,t)=>i("BAD_REQUEST",e,400,t),validation:e=>i("VALIDATION_ERROR","Validation failed",400,e),internal:(e="Internal server error")=>i("INTERNAL_ERROR",e,500),rateLimit:()=>i("RATE_LIMIT","Too many requests",429)}},4235:(e,t,r)=>{r.d(t,{$q:()=>i,Gb:()=>s,Vj:()=>u,lN:()=>a,lf:()=>l});var n=r(1067);let o=n.Ry({cursor:n.Z_().uuid().optional(),limit:n.oQ.number().int().min(1).max(100).default(20)}),a=n.Ry({parentId:n.Z_().uuid().optional(),includeProducts:n.oQ.boolean().default(!1)}),i=o.extend({categoryId:n.Z_().uuid().optional(),search:n.Z_().min(1).max(100).optional()}),s=o.extend({storeId:n.Z_().uuid().optional(),from:n.oQ.date().optional(),to:n.oQ.date().optional()});function u(e,t){let r={};return e.forEach((e,t)=>{r[t]=e}),t.safeParse(r)}function l(e){let t={};for(let r of e.issues)t[r.path.join(".")]=r.message;return t}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,981,67],()=>r(7617));module.exports=n})();