"use strict";(()=>{var e={};e.id=704,e.ids=[704],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:e=>{e.exports=import("pg")},3041:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>l,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>d});var a=r(9303),o=r(8716),s=r(670),i=r(5962),u=e([i]);i=(u.then?(await u)():u)[0];let c=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stats/route",pathname:"/api/stats",filename:"route",bundlePath:"app/api/stats/route"},resolvedPagePath:"/home/phivos/source/github.com/pheever/cy-price-watchdog/server/src/app/api/stats/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:d,serverHooks:m}=c,g="/api/stats/route";function l(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:d})}n()}catch(e){n(e)}})},5962:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{GET:()=>u});var a=r(3538),o=r(9406),s=r(6097),i=e([a]);async function u(e){let t=(0,s.i)(e);if(!(0,s.D)(`stats:${t}`).allowed)return o.R0.rateLimit();try{let[e,t,r,n]=await Promise.all([a._.category.count(),a._.product.count(),a._.store.count(),a._.price.count()]),s=await a._.price.findFirst({orderBy:{scrapedAt:"desc"},select:{scrapedAt:!0}}),i=await a._.price.aggregate({_min:{price:!0},_max:{price:!0},_avg:{price:!0}});return(0,o.Vp)({counts:{categories:e,products:t,stores:r,priceRecords:n},lastScrapedAt:s?.scrapedAt??null,priceRange:{min:i._min.price?.toString()??null,max:i._max.price?.toString()??null,avg:i._avg.price?.toString()??null}})}catch(e){return console.error("Failed to fetch stats:",e),o.R0.internal()}}a=(i.then?(await i)():i)[0],n()}catch(e){n(e)}})},3538:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{_:()=>u});var a=r(3524),o=r(9683),s=r(8678),i=e([s,o]);[s,o]=i.then?(await i)():i;let u=globalThis.prisma??function(){let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL environment variable is required");let t=new s.Pool({connectionString:e}),r=new o.g(t);return new a.PrismaClient({adapter:r,log:["error"]})}();n()}catch(e){n(e)}})},6097:(e,t,r)=>{r.d(t,{D:()=>a,i:()=>o});let n=new Map;function a(e,t={windowMs:6e4,maxRequests:100}){let r=Date.now(),a=n.get(e);return!a||a.resetAt<r?(n.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetAt:r+t.windowMs}):a.count>=t.maxRequests?{allowed:!1,remaining:0,resetAt:a.resetAt}:(a.count++,{allowed:!0,remaining:t.maxRequests-a.count,resetAt:a.resetAt})}function o(e){let t=e.headers.get("x-forwarded-for");return t?t.split(",")[0]?.trim()??"unknown":e.headers.get("x-real-ip")??"unknown"}setInterval(()=>{let e=Date.now();for(let[t,r]of n.entries())r.resetAt<e&&n.delete(t)},6e4)},9406:(e,t,r)=>{r.d(t,{R0:()=>i,Vp:()=>a,e9:()=>o});var n=r(7070);function a(e,t){return n.NextResponse.json({data:e,error:null,meta:t??null})}function o(e,t){return n.NextResponse.json({data:e,error:null,meta:{cursor:t.cursor,hasNext:t.hasNext,total:t.total}})}function s(e,t,r,a){return n.NextResponse.json({data:null,error:{code:e,message:t,fields:a},meta:null},{status:r})}let i={notFound:e=>s("NOT_FOUND",`${e} not found`,404),badRequest:(e,t)=>s("BAD_REQUEST",e,400,t),validation:e=>s("VALIDATION_ERROR","Validation failed",400,e),internal:(e="Internal server error")=>s("INTERNAL_ERROR",e,500),rateLimit:()=>s("RATE_LIMIT","Too many requests",429)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,981],()=>r(3041));module.exports=n})();