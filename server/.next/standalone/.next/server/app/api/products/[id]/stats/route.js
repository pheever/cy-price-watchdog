"use strict";(()=>{var e={};e.id=626,e.ids=[626],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:e=>{e.exports=import("pg")},2853:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l});var n=r(9303),s=r(8716),i=r(670),o=r(8874),c=e([o]);o=(c.then?(await c)():c)[0];let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/products/[id]/stats/route",pathname:"/api/products/[id]/stats",filename:"route",bundlePath:"app/api/products/[id]/stats/route"},resolvedPagePath:"/home/phivos/source/github.com/pheever/cy-price-watchdog/server/src/app/api/products/[id]/stats/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:m}=p,h="/api/products/[id]/stats/route";function u(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}a()}catch(e){a(e)}})},8874:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{GET:()=>c});var n=r(3538),s=r(9406),i=r(6097),o=e([n]);async function c(e,{params:t}){let{id:r}=await t,a=(0,i.i)(e);if(!(0,i.D)(`product-stats:${a}`).allowed)return s.R0.rateLimit();try{if(!await n._.product.findUnique({where:{id:r},select:{id:!0}}))return s.R0.notFound("Product");let e=await n._.price.findFirst({where:{productId:r},orderBy:{scrapedAt:"desc"},select:{scrapedAt:!0}});if(!e)return(0,s.Vp)({current:null,byStore:[]});let t=new Date(e.scrapedAt);t.setHours(t.getHours()-1);let a=await n._.price.aggregate({where:{productId:r,scrapedAt:{gte:t}},_min:{price:!0},_max:{price:!0},_avg:{price:!0},_count:{price:!0}}),i=await n._.$queryRaw`
      SELECT
        s.id as "storeId",
        COALESCE(s."nameEnglish", s.name) as "storeName",
        s.chain as "storeChain",
        MIN(p.price)::float as "minPrice",
        MAX(p.price)::float as "maxPrice",
        AVG(p.price)::float as "avgPrice",
        (
          SELECT p2.price::float
          FROM "Price" p2
          WHERE p2."storeId" = s.id AND p2."productId" = ${r}
          ORDER BY p2."scrapedAt" DESC
          LIMIT 1
        ) as "latestPrice",
        COUNT(p.id)::int as "priceCount"
      FROM "Price" p
      JOIN "Store" s ON p."storeId" = s.id
      WHERE p."productId" = ${r}
      GROUP BY s.id, s.name, s."nameEnglish", s.chain
      ORDER BY "latestPrice" ASC
    `;return(0,s.Vp)({current:{min:a._min.price?Number(a._min.price):null,max:a._max.price?Number(a._max.price):null,avg:a._avg.price?Number(a._avg.price):null,storeCount:a._count.price,scrapedAt:e.scrapedAt},byStore:i.map(e=>({storeId:e.storeId,storeName:e.storeName,storeChain:e.storeChain,current:e.latestPrice,min:e.minPrice,max:e.maxPrice,avg:e.avgPrice,priceCount:e.priceCount}))})}catch(e){return console.error("Failed to fetch product stats:",e),s.R0.internal()}}n=(o.then?(await o)():o)[0],a()}catch(e){a(e)}})},3538:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{_:()=>c});var n=r(3524),s=r(9683),i=r(8678),o=e([i,s]);[i,s]=o.then?(await o)():o;let c=globalThis.prisma??function(){let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL environment variable is required");let t=new i.Pool({connectionString:e}),r=new s.g(t);return new n.PrismaClient({adapter:r,log:["error"]})}();a()}catch(e){a(e)}})},6097:(e,t,r)=>{r.d(t,{D:()=>n,i:()=>s});let a=new Map;function n(e,t={windowMs:6e4,maxRequests:100}){let r=Date.now(),n=a.get(e);return!n||n.resetAt<r?(a.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetAt:r+t.windowMs}):n.count>=t.maxRequests?{allowed:!1,remaining:0,resetAt:n.resetAt}:(n.count++,{allowed:!0,remaining:t.maxRequests-n.count,resetAt:n.resetAt})}function s(e){let t=e.headers.get("x-forwarded-for");return t?t.split(",")[0]?.trim()??"unknown":e.headers.get("x-real-ip")??"unknown"}setInterval(()=>{let e=Date.now();for(let[t,r]of a.entries())r.resetAt<e&&a.delete(t)},6e4)},9406:(e,t,r)=>{r.d(t,{R0:()=>o,Vp:()=>n,e9:()=>s});var a=r(7070);function n(e,t){return a.NextResponse.json({data:e,error:null,meta:t??null})}function s(e,t){return a.NextResponse.json({data:e,error:null,meta:{cursor:t.cursor,hasNext:t.hasNext,total:t.total}})}function i(e,t,r,n){return a.NextResponse.json({data:null,error:{code:e,message:t,fields:n},meta:null},{status:r})}let o={notFound:e=>i("NOT_FOUND",`${e} not found`,404),badRequest:(e,t)=>i("BAD_REQUEST",e,400,t),validation:e=>i("VALIDATION_ERROR","Validation failed",400,e),internal:(e="Internal server error")=>i("INTERNAL_ERROR",e,500),rateLimit:()=>i("RATE_LIMIT","Too many requests",429)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,981],()=>r(2853));module.exports=a})();